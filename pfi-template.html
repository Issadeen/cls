<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Forma Invoice - Classic Petroleum</title>
    <style>
        :root {
            --primary-color: #1e40af; /* Deep blue */
            --secondary-color: #3b82f6; /* Light blue */
            --accent-color: #60a5fa; /* Accent blue */
            --success-color: #2e7d32; /* Green color for highlights */
            --border-color: #cbd5e1; /* Light blue border */
            --font-size-base: 11px; /* Increased base font size for better readability */
            --font-size-small: 10px; /* Increased font size for table */
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.2; /* Slightly increased line height */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background: white;
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            overflow: hidden; /* Prevent content overflow */
        }

        .invoice {
            padding: 1.2cm 1cm; /* Increased padding */
            position: relative;
            box-sizing: border-box;
            width: 210mm;
            height: 297mm;
            max-height: 297mm; /* Ensure exact A4 dimensions */
            overflow: hidden; /* Prevent content overflow */
        }

        .header {
            text-align: center;
            margin-bottom: 0.8rem; /* Increased margin */
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 0.5rem; /* Increased padding */
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 20px; /* Increased font size */
            margin: 8px 0; /* Increased margin */
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.8px; /* Increased letter spacing */
        }

        .company-name {
            color: var(--success-color);
            font-size: 16px; /* Increased font size */
            margin: 0.25rem 0; /* Adjusted margin */
        }

        .logo {
            width: 75px; /* Larger logos */
            height: auto;
        }

        .info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem; /* Increased gap */
            margin: 0.8rem 0; /* Increased margin */
            padding: 10px;
            background: linear-gradient(to right, #e0e7ff, #eef2ff); /* Subtle gradient */
            border-radius: 6px;
            font-size: var(--font-size-base);
            border: 1px solid #d0d7f7;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.8rem 0; /* Increased margin */
            font-size: var(--font-size-small);
        }

        th {
            background: linear-gradient(to bottom, var(--primary-color), #15335d); /* Elegant gradient */
            color: white;
            padding: 8px 6px; /* Increased padding */
            text-align: left;
            font-size: calc(var(--font-size-small) + 1px);
            white-space: nowrap;
        }

        td {
            padding: 6px; /* Increased padding */
            border-bottom: 1px solid var(--border-color);
            font-size: var(--font-size-small);
        }

        .footer {
            margin-top: 0.8rem; /* Increased margin */
            font-size: 0.75em;
            background: linear-gradient(to right, #e0e7ff, #eef2ff); /* Matching gradient */
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #d0d7f7;
        }

        .footer p {
            margin: 3px 0;
            line-height: 1.3;
        }

        .account-details {
            background: #f9f9f9;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            border: 1px dashed #e1e1e1; /* Dashed border for distinction */
        }

        .account-details p {
            margin: 3px 0;
            font-size: var(--font-size-small);
        }

        .signatures {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* Increased gap */
            margin-top: 12px; /* Increased margin */
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .signatures p {
            margin: 3px 0;
            font-size: var(--font-size-small);
        }

        .stamp-container {
            position: relative;
            width: 90px;  /* Increased size */
            height: 90px;
            margin: 5px auto;
        }

        .stamp-image {
            width: 100%;
            height: 100%;
            opacity: 0.8;
            filter: contrast(1.1) brightness(1.05); /* Better stamp visibility */
        }

        .stamp-date {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #1e40af; /* Deep blue */
            font-weight: bold;
            font-size: 9px; /* Increased font size */
            text-align: center;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.7); /* Better visibility */
            padding: 2px 4px;
            border-radius: 3px;
        }

        .signature-img {
            height: 30px; /* Larger signature */
            width: auto;
            margin-top: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            width: 150px; /* Wider line */
            display: block;
            margin-top: 5px;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 0;
            pointer-events: none;
        }

        .watermark img {
            width: 350px;  /* Larger watermark */
            height: auto;
            opacity: 0.04; /* More subtle watermark */
            transform: rotate(-5deg);
            filter: grayscale(100%) contrast(80%);
        }

        .logo-left {
            position: absolute;
            left: 15px;
            top: 15px;
            z-index: 5;
        }

        .logo-right {
            position: absolute;
            right: 15px;
            top: 15px;
            z-index: 5;
        }

        .header p {
            margin: 3px 0;
            font-size: 0.9em; /* Increased font size */
        }

        .header p:first-of-type {  /* Target CLASSIC PETROLEUM text */
            color: #2e7d32;  /* Dark green color */
            font-weight: 600;
            font-size: 1em; /* Increased font size */
            letter-spacing: 0.5px;
        }

        /* QR code styling - moved to bottom */
        #qrCode {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 80px; /* Larger QR code */
            height: 80px;
            z-index: 10;
        }

        /* Special invoice badge - updated z-index and position */
        .invoice-badge {
            position: absolute;
            top: 15px;
            right: 95px; /* Moved to the left of the right logo */
            background: linear-gradient(to right, #FFD700, #FFC400); /* Gold gradient */
            color: #1e40af;
            font-size: 9px; /* Increased font size */
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            letter-spacing: 0.6px;
            border: 1px solid #E6C200;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
            z-index: 10; /* Ensure it's above other elements */
        }

        /* Total amount highlighting */
        #total {
            font-weight: bold;
            font-size: 11px; /* Increased font size */
            color: var(--primary-color);
        }

        /* Row alternating colors for better readability */
        #productsTable tr:nth-child(even) {
            background-color: rgba(240, 244, 255, 0.3);
        }

        /* Hover effect on table rows */
        @media screen {
            #productsTable tr:hover {
                background-color: rgba(224, 231, 255, 0.5);
            }
        }

        /* Print rules */
        @page {
            size: A4 portrait;
            margin: 0;
            padding: 0;
        }

        @media print {
            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
            }
            
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .invoice {
                height: 297mm; /* Exact A4 height */
                width: 210mm; /* Exact A4 width */
                page-break-after: always;
                page-break-inside: avoid;
                padding: 1.2cm 1cm;
                max-height: 297mm;
                margin: 0;
            }
            
            .page-container {
                page-break-inside: avoid;
                page-break-after: always;
                height: 297mm;
                width: 210mm;
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            /* Ensure no orphaned elements across pages */
            table, tr, th, td, .footer, .signatures {
                page-break-inside: avoid;
            }
        }

        /* Bottom container for QR code and verification text */
        .verification-container {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            font-size: 9px; /* Increased font size */
            color: var(--primary-color);
        }

        .verification-text {
            margin-right: 10px;
            max-width: 150px;
            text-align: right;
            line-height: 1.3;
        }
        
        /* Additional styles to make better use of space */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: 85%; /* Use most of the page height */
        }
        
        .product-table-container {
            flex-grow: 1; /* Allow the table to take available space */
            display: flex;
            flex-direction: column;
        }
        
        table.product-table {
            flex-grow: 1;
        }
        
        /* Two-column layout for account details and specifications */
        .footer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        /* Make the table rows taller */
        #productsTable tr td {
            padding-top: 8px;
            padding-bottom: 8px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="invoice">
            <div class="invoice-badge">OFFICIAL DOCUMENT</div>
            <div class="watermark">
                <img src="logo.png" alt="Watermark" crossorigin="anonymous">
            </div>
            <div class="header">
                <img src="logo.png" alt="Left Logo" class="logo logo-left" crossorigin="anonymous">
                <img src="logo.png" alt="Right Logo" class="logo logo-right" crossorigin="anonymous">
                <h1>PRO FORMA INVOICE</h1>
                <p>CLASSIC PETROLEUM LIMITED</p>
                <p>Dealers in: Petroleum products and transportation.</p>
                <p>Kenya Pipeline Co, Annex Bldg</p>
                <p>P.O. Box 10759-30100 ELDORET (K)</p>
                <p>Email: farhanoil9@gmail.com</p>
            </div>
            
            <div class="content-wrapper">
                <div class="info">
                    <div>
                        <p>PFI NO: <span id="pfiNo"></span></p>
                        <p>DATE: <span id="date"></span></p>
                    </div>
                    <div>
                        <p>CUSTOMER: <span id="customer"></span></p>
                        <p>BILL TO: <span id="transport"></span></p>
                    </div>
                </div>
                
                <div class="product-table-container">
                    <table class="product-table">
                        <tr>
                            <th>NO:</th>
                            <th>DESCRIPTION</th>
                            <th>HS CODE</th>
                            <th>QUANTITY</th>
                            <th>UNIT PRICE ($)</th>
                            <th>AMOUNT ($)</th>
                        </tr>
                        <tbody id="productsTable">
                            <!-- Products will be dynamically added here -->
                        </tbody>
                        <tr>
                            <td colspan="5" style="text-align: right;"><strong>TOTAL</strong></td>
                            <td id="total"></td>
                        </tr>
                    </table>
                </div>
                
                <div class="footer">
                    <p>COUNTRY OF ORIGIN: ELDORET KENYA</p>
                    <p>TERM OF SALE: FOT ELDORET</p>
                    <p>VALIDITY: THIS OFFER IS VALID FOR ACCEPTANCE BY CLOSE BUSINESS HOURS</p>
                    <p>TRANSPORTER: ARRANGED BY BUYER</p>
                    
                    <div class="footer-details">
                        <div>
                            <h3 style="margin: 5px 0; font-size: 12px;">ACCOUNT DETAILS</h3>
                            <div class="account-details">
                                <p>AC NAME: CLASSIC PETROLEUM LIMITED</p>
                                <p>AC NO: 1333385277</p>
                                <p>BRANCH: ELDORET WEST</p>
                                <p>SWIFT CODE: KCBLKENX</p>
                                <p>BANK CODE: 01</p>
                                <p>BRANCH CODE: 168</p>
                            </div>
                        </div>
                        <div>
                            <h3 style="margin: 5px 0; font-size: 12px;">CONDITIONS & SPECIFICATIONS</h3>
                            <div class="account-details">
                                <p>All bank charges inside and outside the opening bank are on the account of the applicant.</p>
                                <p>We confirm that the supplied product shall comply with the usual KPC Specification and Supplied by KPC.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="signatures">
                        <div>
                            <p>Approved by: FARHAN JAMA</p>
                            <p>Sign:</p>
                            <span class="signature-line">
                                <img src="issack-signature.png" alt="Issack Signature" class="signature-img">
                            </span>
                        </div>
                        <div>
                            <p>Finance manager: FARHAN JAMA</p>
                            <p>Sign:</p>
                            <span class="signature-line">
                                <img src="jibril-signature.png" alt="Jibril Signature" class="signature-img">
                            </span>
                        </div>
                        <div class="stamp-container">
                            <img src="stamp.png" alt="Official Stamp" class="stamp-image">
                            <div class="stamp-date" id="stampDate"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="verification-container">
                <div class="verification-text">Verify document authenticity by scanning this QR code.</div>
                <div id="qrCode"></div>
            </div>
        </div>
    </div>
    <script>
        function getPFIData() {
            try {
                const params = new URLSearchParams(window.location.search);
                const data = {};
                
                for (const [key, value] of params.entries()) {
                    try {
                        switch(key) {
                            case 'products':
                                // Decode and parse products array
                                const decodedProducts = decodeURIComponent(value);
                                data[key] = JSON.parse(decodedProducts);
                                if (!Array.isArray(data[key])) {
                                    console.warn('Products is not an array, defaulting to empty array');
                                    data[key] = [];
                                }
                                break;
                                
                            case 'pfiNumber':
                            case 'billTo':
                            case 'shipTo':
                            case 'customerId':
                                // Decode URL-encoded strings
                                data[key] = decodeURIComponent(value);
                                break;
                                
                            case 'totalAmount':
                                data[key] = parseFloat(decodeURIComponent(value)) || 0;
                                break;
                                
                            case 'createdAt':
                            case 'stampDate':
                                // Handle dates
                                const decodedDate = decodeURIComponent(value);
                                const date = new Date(decodedDate);
                                data[key] = !isNaN(date.getTime()) ? 
                                    date.toISOString() : 
                                    new Date().toISOString();
                                break;
                                
                            default:
                                data[key] = decodeURIComponent(value);
                        }
                    } catch (e) {
                        console.error(`Error parsing ${key}:`, e);
                        // Set default values for required fields
                        if (key === 'products') data[key] = [];
                        if (key === 'totalAmount') data[key] = 0;
                        if (key.includes('date')) data[key] = new Date().toISOString();
                    }
                }

                console.log('Final parsed data:', data);
                return data;
            } catch (error) {
                console.error('Error parsing PFI data:', error);
                return null;
            }
        }

        function generateQRCode(data) {
            const qrElement = document.getElementById('qrCode');
            if (!qrElement) return;
            
            // Generate verification string with more info for better verification
            const verificationString = `PFI:${data.pfiNumber}|Date:${data.date}|Customer:${data.billTo?.substring(0,20)}|Amount:${data.totalAmount}|Currency:${data.currency || 'USD'}`;
            
            // Create QR code
            new QRCode(qrElement, {
                text: verificationString,
                width: 65,
                height: 65,
                colorDark: "#1e40af",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
        }

        function populatePFI() {
            const data = getPFIData();
            console.log('PopulatePFI received data:', data);
            
            if (!data) return;

            try {
                // Basic fields population
                document.getElementById('pfiNo').textContent = data.pfiNumber || 'N/A';
                document.getElementById('date').textContent = formatDateDisplay(data.date) || 'N/A';
                document.getElementById('customer').textContent = data.billTo || 'N/A';
                document.getElementById('transport').textContent = data.shipTo || 'N/A';

                // Products table population with additional validation
                const productsTable = document.getElementById('productsTable');
                productsTable.innerHTML = '';

                if (Array.isArray(data.products) && data.products.length > 0) {
                    // Calculate max products based on product description length
                    const hasLongDescriptions = data.products.some(p => 
                        p?.description && p.description.length > 50);
                    
                    // Adaptive limit based on content complexity - allow more products now that we have more space
                    const maxProducts = hasLongDescriptions ? 10 : 15;
                    
                    // Limit to ensure single-page fit
                    const displayProducts = data.products.slice(0, maxProducts);
                    
                    // Check if we have very few products and need to add empty rows
                    const minRowsToDisplay = 5;
                    const productsToRender = Math.max(displayProducts.length, minRowsToDisplay);
                    
                    for (let i = 0; i < productsToRender; i++) {
                        const row = document.createElement('tr');
                        
                        // If we have a product for this row, display its data
                        if (i < displayProducts.length) {
                            const product = displayProducts[i];
                            if (product && typeof product === 'object') {
                                const amount = ((product.quantity || 0) * (product.unitPrice || 0)).toFixed(2);
                                
                                // Truncate description if too long
                                let description = product.description || 'N/A';
                                if (description.length > 70) {
                                    description = description.substring(0, 67) + '...';
                                }
                                
                                row.innerHTML = `
                                    <td>${i + 1}</td>
                                    <td>${description}</td>
                                    <td>${product.hsCode || 'N/A'}</td>
                                    <td>${product.quantity || '0'}</td>
                                    <td>${parseFloat(product.unitPrice || 0).toFixed(2)}</td>
                                    <td>${amount}</td>
                                `;
                            }
                        } else {
                            // Add empty row to fill space
                            row.innerHTML = `
                                <td>${i + 1}</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            `;
                            row.style.height = '28px'; // Set explicit height for empty rows
                        }
                        
                        productsTable.appendChild(row);
                    }
                    
                    // Add note if products were truncated
                    if (data.products.length > maxProducts) {
                        const note = document.createElement('tr');
                        note.innerHTML = `<td colspan="6" style="text-align: center; font-style: italic; font-size: 8px;">
                            Note: ${data.products.length - maxProducts} additional items not shown to fit on one page.
                        </td>`;
                        productsTable.appendChild(note);
                    }
                } else {
                    // Add empty placeholder rows if no products
                    for (let i = 0; i < 5; i++) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${i + 1}</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        `;
                        row.style.height = '28px';
                        productsTable.appendChild(row);
                    }
                }

                // Update total with proper formatting
                const total = data.totalAmount ? parseFloat(data.totalAmount).toFixed(2) : '0.00';
                document.getElementById('total').textContent = `${total} ${data.currency || 'USD'}`;

                // Set stamp date
                document.getElementById('stampDate').textContent = formatDate(data.stampDate);

                // Generate QR code for verification
                generateQRCode(data);

                // Auto-download PDF after a delay to ensure rendering
                setTimeout(downloadPDF, 800); // Increased delay for better reliability

            } catch (error) {
                console.error('Error in populatePFI:', error);
            }
        }

        function downloadPDF() {
            const element = document.querySelector('.invoice');
            const pfiNo = document.getElementById('pfiNo').textContent;
            
            // Prepare for PDF generation - force A4 size
            document.body.style.width = '210mm';
            document.body.style.height = '297mm';
            
            const wrapper = document.querySelector('.page-container');
            wrapper.style.width = '210mm';
            wrapper.style.height = '297mm';
            wrapper.style.overflow = 'hidden';
            
            const opt = {
                margin: 0,
                filename: `PFI_${pfiNo}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    scrollX: 0,
                    scrollY: 0,
                    width: 210 * 3.779527559, // Convert mm to px at 96 DPI
                    height: 297 * 3.779527559, // Convert mm to px at 96 DPI
                    logging: false
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait',
                    compress: true,
                    hotfixes: ["px_scaling"],
                    putOnlyUsedFonts: true
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            // Show processing indicator
            const processingIndicator = document.createElement('div');
            processingIndicator.style.position = 'fixed';
            processingIndicator.style.top = '5px';
            processingIndicator.style.left = '50%';
            processingIndicator.style.transform = 'translateX(-50%)';
            processingIndicator.style.background = '#1e40af';
            processingIndicator.style.color = 'white';
            processingIndicator.style.padding = '5px 10px';
            processingIndicator.style.borderRadius = '3px';
            processingIndicator.style.fontSize = '12px';
            processingIndicator.textContent = 'Generating PDF...';
            document.body.appendChild(processingIndicator);

            // Wait for images to load before generating PDF
            Promise.all(Array.from(document.images).filter(img => !img.complete)
                .map(img => new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve; // Continue even if image fails
                }))
            ).then(() => {
                html2pdf()
                    .from(element)
                    .set(opt)
                    .toPdf() // Convert to PDF
                    .get('pdf')
                    .then((pdf) => {
                        // Force one page only
                        if (pdf.getNumberOfPages() > 1) {
                            console.warn('More than one page detected, forcing single page');
                            
                            // Keep only first page
                            for (let i = 2; i <= pdf.getNumberOfPages(); i++) {
                                pdf.deletePage(i);
                            }
                        }
                        
                        // Add metadata
                        pdf.setProperties({
                            title: `Proforma Invoice - ${pfiNo}`,
                            subject: 'Proforma Invoice',
                            creator: 'Classic Petroleum Ltd',
                            author: 'Classic Petroleum System',
                            keywords: 'proforma,invoice,petroleum'
                        });
                        
                        // Save the PDF
                        pdf.save(`PFI_${pfiNo}.pdf`);
                        document.body.removeChild(processingIndicator);
                    })
                    .catch(err => {
                        console.error('PDF generation error:', err);
                        document.body.removeChild(processingIndicator);
                        alert('There was an error generating the PDF. Please try again.');
                    });
            });
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatDateDisplay(dateString) {
            // Handle both ISO dates and normal date strings
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }
                return dateString; // Return as is if not a valid date
            } catch (e) {
                return dateString;
            }
        }

        window.addEventListener('load', function() {
            // Add a small delay to ensure everything is loaded
            setTimeout(populatePFI, 100);
        });
    </script>
    <img src="logo.png" alt="Logo" class="preload-image" crossorigin="anonymous" style="display: none;">
    <img src="stamp.png" alt="Stamp" class="preload-image" crossorigin="anonymous" style="display: none;">
    <img src="issack-signature.png" alt="Signature1" class="preload-image" crossorigin="anonymous" style="display: none;">
    <img src="jibril-signature.png" alt="Signature2" class="preload-image" crossorigin="anonymous" style="display: none;">
</body>
</html>

